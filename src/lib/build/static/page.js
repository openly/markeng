// Generated by CoffeeScript 1.6.3
var Assets, FSManager, MarkengPage, MarkengRenderVars, PageBuilder, StaticComponent, StaticPage, config, customHead, fs, hogan, _;

MarkengPage = require('../../page');

_ = require('underscore');

config = require('../../../config');

hogan = require('hogan.js');

fs = require('fs');

StaticComponent = require('./component');

Assets = require('../../assets');

FSManager = require('../../fs_manager');

customHead = require('../../custom_head');

MarkengRenderVars = require('../../render_vars');

PageBuilder = {
  build: function(assets, dir) {
    return _.each(MarkengPage.all(), function(page) {
      return new StaticPage(page).build(assets, dir);
    });
  }
};

StaticPage = (function() {
  function StaticPage(markengPage) {
    this.markengPage = markengPage;
  }

  StaticPage.prototype.build = function(assets, dir) {
    var fileName, fullContents, fullTemplate, pageContents, pageTemplate;
    fileName = this.getFileName();
    pageTemplate = hogan.compile(this.markengPage.getTemplate());
    fullTemplate = hogan.compile(this.getTemplate());
    pageContents = pageTemplate.render(this.getRenderVars());
    fullContents = fullTemplate.render({
      title: config.title + " :: " + this.markengPage.name,
      stylesheets: this.renderCSS(assets),
      scripts: this.renderJS(assets),
      custom_head: customHead.get(),
      main: pageContents
    });
    return FSManager.writeFile(dir + '/' + fileName, fullContents);
  };

  StaticPage.prototype.getFileName = function() {
    var pageFile;
    pageFile = this.markengPage.name + '.html';
    if (config.home_page === this.markengPage.name) {
      pageFile = 'index.html';
    }
    return pageFile;
  };

  StaticPage.prototype.renderCSS = function(assets) {
    return Assets.renderCSS(assets.css, true);
  };

  StaticPage.prototype.renderJS = function(assets) {
    return Assets.renderJS(assets.js, true);
  };

  StaticPage.prototype.getRenderVars = function() {
    return _.extend({
      root_dir: '/',
      page_dir: '/'
    }, StaticComponent.allAsFunction(this.markengPage.name), MarkengRenderVars.get(this.markengPage.name, null, config.build_tool));
  };

  StaticPage.prototype.getTemplate = function() {
    return fs.readFileSync(__dirname + '/../../../../views/page.html').toString();
  };

  return StaticPage;

})();

module.exports = PageBuilder;

module.exports.PageBuilderClass = StaticPage;
